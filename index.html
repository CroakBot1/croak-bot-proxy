<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>üì° Multi‚ÄëPair 1m Scanner ‚Äî 10k Preload + Smart Alerts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#000; --panel:#0b0b0b; --card:#111; --text:#d2ffd2; --accent:#00ffff; --line:#0f0;
      --up:#34e06f; --dn:#ff5c5c; --warn:#ffd166; --muted:#9fe39f; --grid: 320px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #0f0a;position:sticky;top:0;background:linear-gradient(#000, #000c)}
    header h1{font-size:18px;margin:0;color:#9ff}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls label{font-size:12px;color:#9fe39f}
    .controls input, .controls select, .controls button{background:#0b0b0b;color:var(--text);border:1px solid #0f0;padding:8px 10px;border-radius:10px}
    .controls button{cursor:pointer;transition:transform .08s ease}
    .controls button:active{transform:scale(.98)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--grid),1fr));gap:14px;padding:14px}
    .card{background:var(--card);border:1px solid #0f0;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:240px}
    .card h3{margin:0 0 4px 0;color:var(--accent);font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pill{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #0f0;background:#0b0b0b}
    .kline{font-size:12px;white-space:pre-wrap;word-break:break-word;max-height:150px;overflow:auto;background:#0b0b0b;border:1px solid #0f0;border-radius:10px;padding:8px}

    .score{font-size:28px;font-weight:700}
    .score.up{color:var(--up)}
    .score.dn{color:var(--dn)}
    .score.neutral{color:var(--warn)}

    .mini{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px}
    .mini div{background:#0b0b0b;border:1px solid #0f0;border-radius:10px;padding:6px}

    /* Popup Alerts */
    .toast-wrap{position:fixed;top:12px;right:12px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{border:1px solid #0f0;background:#061;box-shadow:0 10px 30px #000a;border-radius:14px;padding:10px 12px;min-width:260px;max-width:340px}
    .toast h4{margin:0 0 6px 0}
    .toast small{opacity:.8}
    .toast.good{background:#052;}
    .toast.exit{background:#330; border-color:#f93}
    .toast.hold{background:#013; border-color:#09f}

    footer{padding:10px 14px;border-top:1px solid #0f0a;color:#8fb}
    .legend{display:flex;flex-wrap:wrap;gap:6px;font-size:12px}
    .legend span{border:1px solid #0f0;padding:4px 6px;border-radius:999px;background:#0b0b0b}
  </style>
</head>
<body>
  <header>
    <h1>üì° Multi‚ÄëPair 1m WebSocket + Smart Indicator Scanner</h1>
    <div class="controls">
      <label>Preload candles: <input id="preloadCount" type="number" value="10000" min="1000" step="1000" /></label>
      <label>Chunk size: <input id="chunkSize" type="number" value="1000" min="500" step="500" /></label>
      <button id="btnPreload">‚è≥ Preload All</button>
      <button id="btnConnect">üîå Connect Sockets</button>
      <button id="btnMute">üîï Mute</button>
    </div>
  </header>

  <div class="grid" id="grid"></div>

  <footer>
    <div class="legend">
      <span>Signals use: EMA/SMA, MACD, RSI, Stoch, BB, ATR, Donchian, VWAP, OBV, SAR, ADX, Pivots</span>
      <span>Alerts fire only on new candle close to avoid spam</span>
      <span>Linear market (Bybit)</span>
    </div>
  </footer>

  <div class="toast-wrap" id="toasts"></div>
  <audio id="beep"><source src="data:audio/wav;base64,UklGRkQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHG1hZGUgYnkgQ0hBVEdQVC4AAAABAQCA//////8AAP///wAA" type="audio/wav"></audio>

<script>
(() => {
  const WSS = "wss://stream.bybit.com/v5/public/linear";
  const REST = "https://api.bybit.com/v5/market/kline";
  const SYMBOLS = [
    "ETHUSDT","BTCUSDT","SOLUSDT","XRPUSDT","BNBUSDT","LTCUSDT","DOGEUSDT"
  ];

  const state = {}; // per symbol
  const sockets = new Map();
  let muted = false;

  const grid = document.getElementById('grid');
  const toasts = document.getElementById('toasts');
  const beep = document.getElementById('beep');

  // Build UI cards
  for (const sym of SYMBOLS){
    state[sym] = {
      candles:[], lastClose:null, lastStart:null, count:0,
      indicators:{}, score:0, lastSignal:null
    };
    const el = document.createElement('div');
    el.className = 'card';
    el.id = `card-${sym}`;
    el.innerHTML = `
      <div class="row" style="align-items:center">
        <h3>${sym} ‚Äî 1m</h3>
        <div style="text-align:right"><span class="pill" id="pill-${sym}">‚è≥ Waiting...</span></div>
      </div>
      <div class="row">
        <div>
          <div class="mini" id="mini-${sym}">
            <div>EMA14: <b id="ema14-${sym}">‚è≥</b></div>
            <div>SMA14: <b id="sma14-${sym}">‚è≥</b></div>
            <div>MACD: <b id="macd-${sym}">‚è≥</b></div>
            <div>RSI14: <b id="rsi-${sym}">‚è≥</b></div>
            <div>Stoch %K: <b id="stochk-${sym}">‚è≥</b></div>
            <div>BB U/L: <b id="bb-${sym}">‚è≥</b></div>
            <div>VWAP: <b id="vwap-${sym}">‚è≥</b></div>
            <div>ADX: <b id="adx-${sym}">‚è≥</b></div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;justify-content:center">
          <div class="score neutral" id="score-${sym}">0</div>
          <div class="pill" id="sig-${sym}">Signal: ‚è≥</div>
        </div>
      </div>
      <div class="kline" id="log-${sym}">Connecting...</div>
    `;
    grid.appendChild(el);
  }

  // Utils
  const fmt = (n, d=2) => (n==null || isNaN(n))? null : Number(n).toFixed(d);
  const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;

  function toast(type, title, msg){
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    const ts = new Date().toLocaleTimeString();
    t.innerHTML = `<h4>${title}</h4><div>${msg}</div><small>${ts}</small>`;
    toasts.prepend(t);
    if (!muted) { try{beep.currentTime=0;beep.play();}catch(e){} }
    setTimeout(()=> t.remove(), 8000);
  }

  // Indicators
  function SMA(period, data){ if(data.length<period) return null; return avg(data.slice(-period).map(d=>d.close)); }
  function EMA(period, data){ if(data.length<period) return null; const k=2/(period+1); let e = avg(data.slice(0,period).map(d=>d.close)); for(let i=period;i<data.length;i++){ e = data[i].close*k + e*(1-k);} return e; }
  function EMAArray(period, data){ if(data.length<period) return null; const k=2/(period+1); let e=avg(data.slice(0,period).map(d=>d.close)); const out=[e]; for(let i=period;i<data.length;i++){ e=data[i].close*k+e*(1-k); out.push(e);} return out; }
  function EMAFromArray(period, arr){ if(!arr || arr.length<period) return null; const k=2/(period+1); let e = avg(arr.slice(0,period)); const out=[e]; for(let i=period;i<arr.length;i++){ e = arr[i]*k + e*(1-k); out.push(e);} return out; }
  function MACD(data){ const e12=EMAArray(12,data), e26=EMAArray(26,data); if(!e12||!e26) return [null,null,null]; const m = e12.slice(-e26.length).map((v,i)=>v - e26[i]); const s = EMAFromArray(9,m); if(!s) return [null,null,null]; const i=m.length-1; return [m[i], s[i], m[i]-s[i]]; }
  function RSI(period, data){ if(data.length<period+1) return null; let gains=0, losses=0; for(let i=data.length-period;i<data.length;i++){ const diff=data[i].close - data[i-1].close; if(diff>=0) gains+=diff; else losses-=diff; } const ag=gains/period, al=losses/period; if(al===0) return 100; const rs=ag/al; return 100 - 100/(1+rs); }
  function BB(period, data){ if(data.length<period) return [null,null,null]; const slice=data.slice(-period); const m=avg(slice.map(d=>d.close)); const v=avg(slice.map(d=>Math.pow(d.close-m,2))); const sd=Math.sqrt(v); return [m+2*sd, m, m-2*sd]; }
  function ATR(period, data){ if(data.length<period+1) return null; const trs=[]; for(let i=1;i<data.length;i++){ const h=data[i].high,l=data[i].low,pc=data[i-1].close; trs.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc))); } return avg(trs.slice(-period)); }
  function Donch(period, data){ if(data.length<period) return [null,null]; const s=data.slice(-period); return [Math.max(...s.map(d=>d.high)), Math.min(...s.map(d=>d.low))]; }
  function VWAP(data){ let tpv=0, vol=0; for(const k of data){ const tp=(k.high+k.low+k.close)/3; tpv += tp*k.volume; vol += k.volume; } return tpv/vol; }
  function OBV(data){ if(data.length<2) return 0; let obv=0; for(let i=1;i<data.length;i++){ if(data[i].close>data[i-1].close) obv+=data[i].volume; else if(data[i].close<data[i-1].close) obv-=data[i].volume; } return obv; }
  function Pivots(c){ const p=(c.high+c.low+c.close)/3; const s1=2*p - c.high; const r1=2*p - c.low; return [p,s1,r1]; }
  function PSAR(data, step=.02, max=.2){ if(data.length<2) return null; let up=true; let sar=data[data.length-2].low; let ep=data[data.length-2].high; let af=step; for(let i=data.length-2;i<data.length;i++){ if(up){ sar += af*(ep-sar); if(data[i].low < sar){ up=false; sar=ep; ep=data[i].low; af=step;} else if(data[i].high>ep){ ep=data[i].high; af=Math.min(af+step,max);} } else { sar += af*(ep-sar); if(data[i].high > sar){ up=true; sar=ep; ep=data[i].high; af=step;} else if(data[i].low<ep){ ep=data[i].low; af=Math.min(af+step,max);} } } return sar; }
  function ADX(period, data){ if(data.length<period+1) return null; const plus=[], minus=[], trs=[]; for(let i=1;i<data.length;i++){ const up=data[i].high - data[i-1].high; const dn=data[i-1].low - data[i].low; plus.push(up>dn && up>0? up:0); minus.push(dn>up && dn>0? dn:0); trs.push(Math.max(data[i].high-data[i].low, Math.abs(data[i].high-data[i-1].close), Math.abs(data[i].low-data[i-1].close))); } const atr=avg(trs.slice(-period)); const p=100*(avg(plus.slice(-period))/atr); const m=100*(avg(minus.slice(-period))/atr); const dx=100*Math.abs(p-m)/(p+m); return dx; }
  function Stoch(period, data){ if(data.length<period) return [null,null]; const s=data.slice(-period); const h=Math.max(...s.map(d=>d.high)); const l=Math.min(...s.map(d=>d.low)); const c=data[data.length-1].close; const k=((c-l)/(h-l))*100; // simple D 3‚Äëperiod SMA of K
    const prevK = data.__k || []; prevK.push(k); if(prevK.length>3) prevK.shift(); data.__k = prevK; const d = prevK.length===3? avg(prevK): null; return [k,d]; }

  function computeIndicators(sym){
    const S = state[sym]; const D = S.candles; if(D.length<35) return; // need some data
    const ema14 = EMA(14,D), sma14 = SMA(14,D);
    const [macd, signal, histo] = MACD(D);
    const rsi = RSI(14,D);
    const [bbu, bbm, bbl] = BB(20,D);
    const atr = ATR(14,D);
    const [dch, dcl] = Donch(20,D);
    const vwap = VWAP(D);
    const obv = OBV(D);
    const [pivot,s1,r1] = Pivots(D[D.length-1]);
    const psar = PSAR(D);
    const adx = ADX(14,D);
    const [k,d] = Stoch(14,D);

    S.indicators = {ema14,sma14,macd,signal,histo,rsi,bbu,bbm,bbl,atr,dch,dcl,vwap,obv,pivot,s1,r1,psar,adx,k,d};
    renderIndicators(sym);
    scoreAndSignal(sym);
  }

  function renderIndicators(sym){
    const id = q=>document.getElementById(`${q}-${sym}`);
    const I = state[sym].indicators; if(!I) return;
    id('ema14').textContent = fmt(I.ema14);
    id('sma14').textContent = fmt(I.sma14);
    id('macd').textContent = [fmt(I.macd,4),fmt(I.signal,4),fmt(I.histo,4)].join(' / ');
    id('rsi').textContent = fmt(I.rsi);
    id('stochk').textContent = [fmt(I.k), fmt(I.d)].join(' / ');
    id('bb').textContent = `${fmt(I.bbu)} | ${fmt(I.bbl)}`;
    id('vwap').textContent = fmt(I.vwap);
    id('adx').textContent = fmt(I.adx);
  }

  function scoreAndSignal(sym){
    const S = state[sym]; const D=S.candles; const I=S.indicators; if(!I) return; const c=D[D.length-1].close;
    let score = 0; // ensemble signal
    if(I.ema14 && I.sma14) score += I.ema14 > I.sma14 ? 1 : -1; // trend
    if(I.histo!=null && I.histo>0) score += 1; else if(I.histo!=null) score -= 1; // momentum
    if(I.rsi!=null){ if(I.rsi<32) score += 1; if(I.rsi>70) score -= 1; }
    if(I.k!=null && I.d!=null){ if(I.k>I.d && I.k<60) score += 1; if(I.k<I.d && I.k>40) score -= 1; }
    if(I.adx!=null && I.adx>20) score += 0.5; // trend strength
    if(I.vwap!=null){ if(c>I.vwap) score += 0.5; else score -= 0.5; }
    if(I.bbu && I.bbl){ if(c <= I.bbl*1.005) score += 1; if(c >= I.bbu*0.995) score -= 1; }

    S.score = Number(score.toFixed(2));
    const scoreEl = document.getElementById(`score-${sym}`);
    scoreEl.textContent = S.score;
    scoreEl.className = 'score ' + (S.score>0.5? 'up' : S.score<-0.5? 'dn':'neutral');

    let tag = 'HOLD', tclass='hold';
    if(S.score>=3) { tag = 'GOOD LONG ENTRY'; tclass='good'; }
    else if(S.score<=-2 || (I.rsi && I.rsi>72)) { tag='GOOD EXIT'; tclass='exit'; }

    const pill = document.getElementById(`sig-${sym}`);
    pill.textContent = `Signal: ${tag}`;

    // Fire popup only on candle close and when changed
    if(S.lastSignal !== tag && S._justClosed){
      toast(tclass, `${sym} ‚Äî ${tag}`, `Price: ${fmt(c)} | Score ${S.score}`);
      S.lastSignal = tag;
    }
  }

  function log(sym, k, isNew){
    const el = document.getElementById(`log-${sym}`);
    const ts = new Date(k.start*1000).toLocaleTimeString();
    const delta = state[sym].lastClose!=null? (k.close - state[sym].lastClose).toFixed(4): 'N/A';
    const head = isNew? 'üü¢ NEW' : '‚ö° LIVE';
    el.textContent = `${head}  ${ts}\nO:${k.open}  H:${k.high}  L:${k.low}  C:${k.close} (Œî ${delta})  V:${k.volume}\n\n` + el.textContent;
  }

  async function preloadSymbol(sym, total, chunk){
    const S = state[sym];
    const params = new URLSearchParams({category:'linear', symbol:sym, interval:'1', limit:String(chunk)});
    let fetched = 0;
    let start = Math.floor(Date.now()/1000) - total*60; // go back in time
    const out = [];
    while(fetched < total){
      params.set('start', String(start*1000));
      const url = `${REST}?${params.toString()}`;
      try{
        const res = await fetch(url);
        const j = await res.json();
        if(j.retCode!==0 || !j.result?.list || j.result.list.length===0) break;
        const batch = j.result.list.map(c=>({
          start: Math.floor(c[0]/1000),
          open: +c[1], high:+c[2], low:+c[3], close:+c[4], volume:+c[5]
        }));
        out.push(...batch);
        fetched += batch.length;
        start = Math.floor(batch[batch.length-1].start) + 60; // move forward
        document.getElementById(`pill-${sym}`).textContent = `Preloaded ${fetched}/${total}`;
        await new Promise(r=>setTimeout(r, 250));
      }catch(e){
        document.getElementById(`pill-${sym}`).textContent = `Error preload: ${e.message}`;
        break;
      }
    }
    // keep last 300 for indicator stability
    S.candles = out.slice(-300);
    S.count = out.length;
    S.lastClose = S.candles.length? S.candles[S.candles.length-1].close : null;
    S.lastStart = S.candles.length? S.candles[S.candles.length-1].start : null;
    document.getElementById(`pill-${sym}`).textContent = `Ready ‚Ä¢ ${out.length} loaded`;
    computeIndicators(sym);
  }

  function connect(){
    const sock = new WebSocket(WSS);
    sock.onopen = ()=>{
      const args = SYMBOLS.map(s=>`kline.1.${s}`);
      sock.send(JSON.stringify({op:'subscribe', args}));
      toast('hold','WebSocket','Connected and subscribed to 7 symbols');
    };
    sock.onmessage = (ev)=>{
      const msg = JSON.parse(ev.data);
      if(!msg.topic || !msg.data) return;
      const m = msg.topic.match(/kline\.1\.(\w+)/);
      if(!m) return; const sym = m[1];
      const raw = Array.isArray(msg.data)? msg.data[0]: msg.data;
      const k = {
        start: Number(raw.start),
        open: Number(raw.open),
        high: Number(raw.high),
        low: Number(raw.low),
        close: Number(raw.close),
        volume: Number(raw.volume)
      };
      const S = state[sym]; if(!S) return;
      const isNew = k.start !== S.lastStart;
      if(isNew){
        S._justClosed = true; // flag for alert
        S.count++; S.lastClose = k.close; S.lastStart = k.start; S.candles.push(k); if(S.candles.length>300) S.candles.shift();
        computeIndicators(sym);
      }else{
        // update last candle live
        if(S.candles.length){ Object.assign(S.candles[S.candles.length-1], k); S._justClosed=false; computeIndicators(sym); }
      }
      log(sym,k,isNew);
    };
    sock.onerror = ()=> toast('exit','WebSocket','Error');
    sock.onclose = ()=> toast('exit','WebSocket','Closed');
    sockets.set('main', sock);
  }

  // Controls
  document.getElementById('btnPreload').addEventListener('click', async ()=>{
    const total = Math.max(1000, Number(document.getElementById('preloadCount').value)||10000);
    const chunk = Math.max(500, Number(document.getElementById('chunkSize').value)||1000);
    for(const s of SYMBOLS){ await preloadSymbol(s,total,chunk); }
    toast('good','Preload Complete', `${SYMBOLS.length} symbols ‚Ä¢ up to ${total} candles each (in ${chunk}s)`);
  });
  document.getElementById('btnConnect').addEventListener('click', ()=>{
    if(!sockets.has('main')) connect();
  });
  document.getElementById('btnMute').addEventListener('click', (e)=>{
    muted = !muted; e.target.textContent = muted? 'üîï Muted' : 'üîî Sound On';
  });

  // Auto start with a light preload (10k by default)
  (async()=>{
    const total = Number(document.getElementById('preloadCount').value);
    const chunk = Number(document.getElementById('chunkSize').value);
    for(const s of SYMBOLS){ await preloadSymbol(s,total,chunk); }
    connect();
  })();
})();
</script>
</body>
</html>
